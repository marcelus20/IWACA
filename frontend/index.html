  <html>
      <head>
          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css" />
            <link rel="stylesheet" href="index.css" />
        </head>
  
    <body>
                
        <div class="table wrap">
            <div class="row">
                <div class="myform col">   
                    <label>Player Name</label>
                    <input id="nam" class="form-control" name="name_" placeholder="type name"/>
                    <label>Level</label>
                    <input type="number" id="lev" class="form-control" name="level_" placeholder="type level"/>
                    <div class="form-group">
                        <label for="city">Vocation</label>
                        <select class="form-control" id="voc">
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <select class="form-control" id="cit">
                        </select>
                    </div>
                   <div class="form-group">
                        <label for="city">Sex</label>
                        <select class="form-control" id="sex">
                        <option>F</option>
                        <option>M</option>
                        </select>
                    </div>
                    <button value="submit" class="btn btn-secondary" id="sub">Submit</button>            
                </div>
                <div class="data-table col">
                    <div class="table" id="data">
                           Could not fetch data because it did not match schema
                    </div>
                </div>
                <div class="col">
                    <h4 class="display-4">Delete By Id</h4>
                    <label>id</label>
                    <input id="idDelete" class="form-control"  placeholder="type id to delete"/>
                    <button value="submit" class="btn btn-secondary" id="idDel">Delete</button>
                </div>
            </div>
            
        </div>
        <div class="alert alert-success hide" role="alert" id="added">
            Player added successfully
        </div>
        <div class="alert alert-danger hide" role="alert" id="failed">
        </div>
        <script>
                    const added = document.querySelector('#added');
                    const dataDiv = document.querySelector('#data');
                    const subButton = document.querySelector('#sub');
                    const delButton = document.querySelector('#idDel');
                    const selectCities = document.querySelector("#cit");
                    const selectVoc = document.querySelector("#voc");
                    const failedAlert = document.querySelector('#failed');

                const showElement = (el)=>{
                    el.classList.remove('hide');
                }

                const hideElement = (el)=>{
                    el.classList.add('hide');
                }

                const showAndHide = el =>{
                    showElement(el);
                    setTimeout(()=>{
                        hideElement(el);
                    }, 10000);
                }
                const showSuccessAlert = msg =>{
                    added.innerHTML = msg;
                    showAndHide(added);
                }

                const showErrorAlert = msg =>{
                    failedAlert.innerHTML = msg;
                    showAndHide(failedAlert);
                }

                    
                const getPlayers = () => {

                    const tableHeader = `
                    <div class="title">
                            <h2 class="display-2">Players List</h2>
                        </div>
                        <div class="row">
                            <div class="col">
                                <p>id</p>
                            </div>
                            <div class="col">
                                <p>Player Name</p>
                            </div>
                            <div class="col">
                                <p>Level</p>
                            </div>
                            <div class="col">
                                <p>vocation</p>
                            </div>
                            <div class="col">
                                <p>city</p>
                            </div>
                            <div class="col">
                                <p>sex</p>
                            </div>
                        </div>
                    
                    `;

                    fetch('/players')
                    .then(response=>response.text())
                    .then(text => {
                        
                            
                        dataDiv.innerHTML = tableHeader + JSON.parse(text).map(player=>`
                            <div class="row">
                                <div class="col">${player.id}</div>
                                <div class="col">${player.name}</div>
                                <div class="col">${player.level}</div>
                                <div class="col">${player.vocation}</div>
                                <div class="col">${player.city}</div>
                                <div class="col">${player.sex}</div>
                            </div>
                        `).reduce((acc,item)=>acc + item, '')
                        
                        
                        
                     })
                }

                

                fetch('/cities')
                    .then(response=> response.text())
                    .then(json=>{
                        selectCities.innerHTML = JSON.parse(json).map(city=>`
                        <option>${city}</option>
                        `).reduce((acc, item)=>acc + item), '';
                    })

                     fetch('/vocations')
                    .then(response=> response.text())
                    .then(json=>{
                        selectVoc.innerHTML = JSON.parse(json).map(vocation=>`
                        <option>${vocation}</option>
                        `).reduce((acc, item)=>acc + item), '';
                    })
                    
                    
                    subButton.addEventListener('click', ()=>{
                        const form = {};
                        form["name"] = document.querySelector('#nam').value.trim();
                        form["level"] = document.querySelector('#lev').value.trim();
                        form["vocation"] = document.querySelector('#voc').value.trim();
                        form["city"] = document.querySelector('#cit').value.trim();
                        form["sex"] = document.querySelector('#sex').value.trim();

                        fetch('/create_player', {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                            body: JSON.stringify(form)
                        }).then(res=>res.text())
                        .then(text=>{
                            if(text === 'true'){
                                showSuccessAlert("Player Added Sucessfully");
                                getPlayers();
                            }else{
                                showErrorAlert("Schema does not match or something else went wrong");
                            }
                            
                        });
                });

                delButton.addEventListener('click', ()=>{
                        const id = document.querySelector('#idDelete').value.trim();
                        fetch(`/delete_player?id=${id}`, {
                            method: "DELETE",
                        }).then(res=>res.text())
                        .then(text=>{
                            if(text === 'false'){
                                showErrorAlert('Id does not exist');
                            }else{
                                getPlayers();
                                showSuccessAlert('Player successfully deleted!');
                            }
                            
                        });
                });

                getPlayers();
                

                        
                    
        
;

        </script>
</body>
  </html>


